<!DOCTYPE html>
<html data-bs-theme="dark">
<head>
    <title>Game Test</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <script src="https://unpkg.com/@alenaksu/json-viewer@2.0.0/dist/json-viewer.bundle.js"></script>
    <style>
    </style>
</head>
<body>
<div class="container-fluid main mb-5 row mt-4">
    <div class="col-md-3">
        <h3>Game</h3>
        <div class="mb-3">
            <label for="gameId" class="form-label">Connect to Game WS</label>
            <div class="input-group">
                <input type="text" class="form-control" id="gameId" placeholder="ID"/>
                <button id="joinGame" class="btn btn-primary">Join Game</button>
            </div>
        </div>
        <json-viewer id="gameStateJson"></json-viewer>
    </div>
    <div class="col-md-5">
        <h3>Actions</h3>

        <div class="mb-3 d-flex flex-row align-items-center">
            <div class="col-8">
                <div class="input-group">
                    <input type="text" class="form-control" id="userId" placeholder="ID"/>
                </div>
            </div>
            <div class="col-3">
                <button id="authorize" class="btn btn-secondary ms-3 w-100">Authorize</button>
            </div>
        </div>

        <div class="mb-3 d-flex flex-row align-items-center">
            <div class="col-8">
                <div class="input-group">
                    <input type="text" class="form-control" id="latitude" placeholder="Latitude"/>
                    <input type="text" class="form-control" id="longitude" placeholder="Longitude"/>
                </div>
            </div>
            <div class="col-3">
                <button id="sendCoords" class="btn btn-success ms-3 w-100">Update location</button>
            </div>
        </div>

        <div class="mb-3 d-flex flex-row align-items-center">
            <div class="col-8">
                <div class="input-group">
                    <input type="text" class="form-control" id="taskPhotoId" placeholder="Photo ID"/>
                    <input type="text" class="form-control" id="taskId" placeholder="Task ID"/>
                </div>
            </div>
            <div class="col-3">
                <button id="sendTaskCompleted" class="btn btn-info ms-3 w-100">Complete task</button>
            </div>
        </div>
        <div class="mb-3 d-flex flex-row align-items-center">
            <div class="col-8">
                <div class="input-group">
                    <input type="text" class="form-control" id="catchPlayerSecret" placeholder="Secret"/>
                </div>
            </div>
            <div class="col-3">
                <button id="catchPlayer" class="btn btn-warning ms-3 w-100">Catch player</button>
            </div>
        </div>
        <div class="mb-3 d-flex flex-row align-items-center">
            <div class="col-8">
                <div class="input-group">
                    <input type="text" class="form-control" id="duration" placeholder="01:00:00"/>
                    <input type="text" class="form-control" id="questTasks" placeholder="1 2 3"/>
                </div>
            </div>
            <div class="col-3">
                <button id="updateSettings" class="btn btn-primary ms-3 w-100">Update Settings</button>
            </div>
        </div>


        <div class="mb-3 d-flex flex-row">
            <button id="startGame" class="btn btn-success">Start Game</button>
        </div>
        <div class="mb-3 d-flex flex-row">
            <button id="getGameState" class="btn btn-secondary">Get Game State</button>
        </div>
        <div class="mb-3">
            <label for="customData" class="form-label">Enter custom data:</label>
            <div class="input-group w-75">
                <textarea class="form-control" id="customData" placeholder="Data"></textarea>
            </div>
            <button id="sendCustomData" class="btn btn-info mt-2" value='{"event":"Hi!"}'>Send</button>
        </div>
    </div>
    <div class="col-md-4">
        <h3>Messages</h3>
        <div id="messages" class="w-100 border rounded-2 h-100 p-2"></div>
    </div>
</div>


<script>
    var currentGameId = 0;
    var socket = null
    var user = {}

    function connectWebSocket() {
        socket = new WebSocket(
            `wss://${window.location.host}/ws/game/${currentGameId}/`
        );
        if (!currentGameId) {
            console.error("Game ID is not set");
            return;
        }

        socket.onopen = function (e) {
            console.log("Connection established");
        };


        socket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            console.log("Message received:", data);
            if (data.event === "gamestate_update" || data.event === "get_gamestate") {
                gameState = data.state
                updateGameState()
            } else if (data.event === "settings_update") {
                getGameState()
            } else {
                $("#messages").append("<json-viewer>" + JSON.stringify(data, null, 2) + "</json-viewer>");
            }
        };

        socket.onclose = function (e) {
            console.log("Connection closed");
        };

        socket.onerror = function (error) {
            console.error("WebSocket Error:", error);
        };
    }

    let gameState = {};

    function updateGameState() {
        document.querySelector("#gameStateJson").data = gameState
    }

    function joinGame() {
        var gameId = $("#gameId").val();
        if (gameId) {
            currentGameId = gameId;
            connectWebSocket();
        } else {
            console.error("Game ID is required");
        }
    }

    function authorize() {
        var userId = $("#userId").val();
        user = {
            "id": userId
        }
        if (userId) {
            socket.send(
                JSON.stringify({
                    "user": user,
                    "event": "authorization",
                    "token": userId
                })
            )
        } else {
            console.error("User ID is required");
        }

    }

    function sendCoords() {
        var latitude = $("#latitude").val();
        var longitude = $("#longitude").val();
        socket.send(
            JSON.stringify({
                "event": "location_update",
                "user": user,
                "coordinates": {
                    latitude, longitude
                }
            })
        )
    }

    function sendTaskCompleted() {
        var task_id = $("#taskId").val();
        var photo_id = $("#taskPhotoId").val();
        socket.send(
            JSON.stringify({
                "user": user,
                "event": "task_completed",
                "task_id": task_id,
                "photo_id": photo_id
            })
        )
    }

    function catchPlayer() {
        var catchPlayerSecret = $("#catchPlayerSecret").val();
        socket.send(
            JSON.stringify({
                "user": user,
                "event": "player_caught",
                "secret": catchPlayerSecret
            })
        )
    }

    function startGame() {
        socket.send(
            JSON.stringify({
                "user": user,
                "event": "start_game"
            })
        )
    }

    function updateSettings() {
        var duration = $("#duration").val();
        var quest_task_ids = $("#questTasks").val().split(" ");
        if ($("#questTasks").val().length === 0) {
            quest_task_ids = []
        }
        var quest_point = {
            "id": 1,
            "tasks": []
        }
        quest_task_ids.forEach((quest_task_id) => {
            quest_point["tasks"].push({"id": quest_task_id})
        })
        socket.send(
            JSON.stringify({
                "user": user,
                "event": "settings_update",
                "settings": {
                    "duration": duration,
                    "quest_points": [quest_point]
                }
            })
        )
    }

    function sendCustomData() {
        var customData = $("#customData").val();
        socket.send(
            customData
        )
    }

    function getGameState() {
        socket.send(
            JSON.stringify({
                "user": user,
                "event": "get_game_state"
            })
        )
    }

    $(document).ready(function () {
        $("#joinGame").click(joinGame);
        $("#authorize").click(authorize);
        $("#sendCoords").click(sendCoords);
        $("#sendCustomData").click(sendCustomData);
        $("#sendTaskCompleted").click(sendTaskCompleted);
        $("#catchPlayer").click(catchPlayer);
        $("#getGameState").click(getGameState);
        $("#updateSettings").click(updateSettings);
        $("#startGame").click(startGame);
    });
</script>
</body>
</html>
